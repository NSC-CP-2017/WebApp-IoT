var http = require('http');
var weatherKey = require("../secrets/weatherKey");
var request = require('request');
var fs = require('fs');
var Weather = require('mongoose').model('weather');

exports.getWeatherFromCityID = function(req, res){
  var local_city_id = req.query.city_id;
  var local_dt = req.query.dt;
  Weather.findOne({city_id : local_city_id, dt : local_dt}, function(err, weather){
      if(err){
        res.status(500).json({msg : "internal error"});
      }
      else if(!weather){
        res.status(404).json({msg : "weather not found"});
      }
      else{
        res.status(200).json(weather);
      }
  });
}

// sleep time expects milliseconds
function sleep (time) {
  return new Promise((resolve) => setTimeout(resolve, time));
}
var fetchOneID = function(cid){
  var url = 'http://api.openweathermap.org/data/2.5/forecast?id='+thaiCityIds[cid]+'&appid='+weatherKey.appid;
  http.get(url, (resp) => {
    let data = '';

    // A chunk of data has been recieved.
    resp.on('data', (chunk) => {
      data += chunk;
    });

    // The whole response has been received. Print out the result.
    resp.on('end', () => {
      data = JSON.parse(data);
      var promises = [];
      for(let i=0;i<data.list.length;i++){
        promises.push(new Promise(function(resolve, reject){
          let index = i;
          if(data.list[index].rain['3h'] == undefined){
            data.list[index].rain = {"3h" : 0};
          }
          var new_cid = thaiCityIds[cid].toString();
          var new_dt = data.list[index].dt.toString();
          var new_pos = {'type':'Point','coordinates':[data.city.coord.lon,data.city.coord.lat]}
          Weather.findOneAndUpdate({city_id : new_cid, dt : new_dt}, {$set : {
              city : data.city.name,
              city_id : data.city.id,
              pos : new_pos,
              dt : data.list[index].dt,
              temp : data.list[index].main.temp,
              humidity : data.list[index].main.humidity,
              weather : data.list[index].weather,
              rain : data.list[index].rain['3h'],
              wind : data.list[index].wind.speed
          }}, {new: true, upsert: true}, function(err, weather){
              if(err){
                var obj = {};
                obj.msg = "error";
                reject(obj);
              }
              else{
                resolve();
              }
          });
        }));
      }
      Promise.all(promises).catch(function(obj){
        return obj;
      }).then(function(){
        return {msg : "done"};
      });
    }).on("error", (err) => {
      console.log("Error: " + err.message +"\nFrom CID: "+cid);
    });
  });
}
exports.fetchWeather = function(req, res){
  if(req.cid == undefined || req.cid == null){
    req.cid = 0;
  }
  //==== this part is for testing =======
  thaiCityIds = testThaiCityIds;
  //==== end testing part ===============
  console.log("req.cid = "+req.cid);
  if(req.cid == thaiCityIds.length){
    res.status(201).json({msg : "done"});
    return ;
  }
  for(;req.cid < thaiCityIds.length && req.cid < req.cid+60;req.cid++){
    let rsp = fetchOneID(req.cid);
    if(rsp != undefined && rsp.hasOwnProperty('error')){
      res.status(500).json(rsp);
      return ;
    }
  }
  sleep(60000).then(function(){
    exports.fetchWeather(req, res);
  });
}

exports.testFetch = function(req, res){
  var url = 'http://api.openweathermap.org/data/2.5/forecast?id='+thaiCityIds[0]+'&appid='+weatherKey.appid;
  http.get(url, (resp) => {
  let data = '';

  // A chunk of data has been recieved.
  resp.on('data', (chunk) => {
    data += chunk;
  });

  // The whole response has been received. Print out the result.
  resp.on('end', () => {
    console.log(JSON.parse(data));
    res.status(200).json({msg : "done"});
  });

}).on("error", (err) => {
  console.log("Error: " + err.message);
});
};


var testThaiCityIds = [1607257,1609031,1608525];

var thaiCityIds = [1607257,1609031,1608525,1117328,1153555,1156944,1609283,1611268,1614614,1607016,7735862,1609348,1607542,1606589,6908616,1618360,1608132,1609350,6695671,1153080,7621325,1906687,1600098,1608528,1618905,1608057,1608526,1616236,1599922,1608899,1610510,1604767,1611884,1906686,7680198,8136321,1604054,1119013,1151933,1153958,1619638,1150154,1150210,1152194,1152432,1152562,1153089,1152953,1153850,1610468,1604654,1604771,1906691,1605119,1605279,1605538,1608231,1605677,8133594,1607083,1607280,1607725,1607778,1607793,1611438,1607982,1608269,1610187,1610459,1610538,1611026,1614336,6696291,1151073,1155325,1155876,1605277,1151416,1614968,1611108,1612740,1613664,1606587,1617635,1621034,1618205,1906688,1600900,1605214,1599143,7510909,1150085,1150953,1151063,1152188,1152202,1152377,1156257,1595679,1599640,1603235,1605221,1606343,1608533,1607068,1607439,1607512,1607615,1607708,1607730,1608136,1608538,1608595,1609345,1609990,1610185,1610505,1610963,1611424,1613284,1948015,1605651,1150514,1119767,1597591,1617290,1607724,1599907,1607736,1616495,1618918,1616123,1606789,7918493,1608530,1597746,8136536,1601026,1603424,8136306,8136656,8136670,8136559,1150532,1330822,8136647,8136643,1603254,1603453,1603521,8136357,1597447,8136685,8136354,1608483,8136662,8136363,8136550,8181956,1607551,1155284,1601453,8136190,8136189,1620025,8136781,1613268,1603437,8136802,1603679,1950675,1616593,1599062,1153670,1607758,1619006,1153668,7505667,1611415,1155606,1120350,1604546,1151074,1617527,1152472,1614295,1618154,1157835,1618767,1603410,1612688,7918578,1603786,8136529,1604226,1157073,1616590,1154843,1153669,1152631,1156778,1607707,1601433,1151253,1117652,1607530,1618100,1606146,1606147,1152473,1150006,1150007,1152633,1604869,1604870,1150964,1150965,1607976,1941157,1606029,1606030,1608048,1610780,1605245,1608451,7319272,1605403,1598267,1152467,8136555,1607000,1604017,1616371,1615717,1611452,1613591,1609070,8040258,1609775,1600176,7466788,1156115,1158126,1614396,6791036,1118576,1608408,1941183,1119754,1616639,1150489,8164011,7581129,7420462,1156396,1152221,1152222,1156379,1612048,1602641,1620083,1606032,1117971,1117656,1117823,1149698,1149965,1150246,1150275,1150490,1150515,1150533,1150624,1150681,1150728,1150732,1150921,1150954,1151211,1151254,1151340,1151426,1151528,1152227,1152468,1152919,1153034,1153035,1153081,1153090,1153241,1153269,1153386,1153464,1153513,1153557,1153646,1153807,1154677,1155139,1156046,1157662,1157683,1601579,1604452,1906690,1604769,1605018,1605024,1605069,1605102,1605118,1605215,1605239,1605467,1605509,1605601,1605754,1605957,1606033,1606050,1606238,1606239,1606250,1606269,1606270,1606350,1606375,1606376,1606386,1606417,1606418,1606585,1606586,1606588,1606590,1606638,1606790,1606807,1606939,1607001,1607017,1607435,1611406,1607508,1607532,1607552,1607737,1607779,1607801,1607838,1607865,1607978,1607983,1608033,1608133,1608191,1608232,1608239,1608409,1608424,1608452,1608462,1608527,1608529,1608531,1608534,1608539,1608541,1608597,1608900,1609032,1609043,1609071,1609278,1609324,1609395,1609610,1609776,1609795,1609899,1610227,1610469,1610503,1610940,1610943,1611106,1611110,1611135,1611269,1611407,1611416,1611439,1611492,1611635,1613769,1614455,1614465,1616658,1617111,1619276,1619281,1619363,1619369,1619400,1619415,1619423,1619434,1619437,1619602,1619616,1619650,1620254,1620442,1620875,1620919,1621020,1906689,1621060,7091861,7091912,1153671,1116760,1117344,1117557,1118429,1119287,1119933,1120440,1120443,1120449,1120453,1149700,1149757,1149878,1149881,1149882,1149883,1149892,1149903,1149915,1149964,1149975,1150076,1150081,1150089,1150133,1150196,1150200,1150203,1150218,1150221,1150227,1150296,1150317,1150338,1150340,1150447,1150452,1150544,1150562,1150607,1150626,1150643,1150651,1150659,1150678,1150683,1150700,1150726,1150735,1150783,1150786,1150844,1150854,1151150,1151278,1151296,1151308,1151350,1151397,1151429,1151446,1151449,1151464,1151477,1151523,1151557,1151567,1151601,1151634,1151664,1151710,1151730,1151848,1151958,1151987,1152180,1152181,1152186,1152204,1152216,1152217,1152230,1152322,1152357,1152375,1152408,1152420,1152421,1152423,1152426,1152479,1152625,1152640,1152654,1152657,1152670,1152679,1152762,1152765,1152843,1152850,1152854,1152873,1152876,1152899,1152933,1153059,1153062,1153072,1153079,1153263,1153278,1153389,1153427,1153467,1153507,1153634,1153673,1153686,1153783,1153788,1153800,1153981,1154093,1154094,1154190,1154329,1154519,1154689,1155010,1155064,1155214,1155231,1155525,1155656,1155740,1155989,1156244,1156648,1156739,1156836,1157232,1157241,1157249,1157277,1157482,1157551,1157590,1157660,1157725,1157730,1157794,1157949,1157966,1157971,1158377,1158412,1158432,1595207,1595484,1595865,1596216,1597130,1597163,1598222,1598417,1598434,1598503,1599042,1599114,1599410,1599641,1600104,1600129,1600435,1600444,1600500,1600752,1600814,1600964,1600983,1601446,1601787,1603291,1603642,1603666,1604060,1604194,1604597,1604600,1604606,1604614,1604632,1604664,1604710,1604761,1604792,1604797,1604807,1604863,1604979,1605022,1605026,1605043,1605048,1605062,1605070,1605072,1605074,1605076,1605092,1605104,1605145,1605149,1605156,1605176,1605179,1605219,1605223,1605248,1605268,1605281,1605355,1605409,1605451,1605469,1605473,1605475,1605479,1605481,1605483,1605490,1605529,1605549,1605550,1605607,1605613,1605639,1605671,1605742,1605763,1605773,1605810,1605843,1605912,1606017,1606019,1606040,1606043,1606047,1606073,1606114,1606139,1606167,1606188,1606213,1606228,1606229,1606232,1606237,1606246,1606257,1606283,1606291,1606302,1606303,1606314,1606316,1606323,1606334,1606336,1606340,1606374,1606378,1606394,1606489,1606505,1606512,1606520,1606530,1606536,1606537,1606543,1606564,1606615,1606640,1606667,1606685,1606687,1606726,1606837,1606842,1606851,1606913,1606944,1606961,1606983,1606988,1607013,1607028,1607030,1607055,1607062,1607097,1607161,1607164,1607236,1607244,1607251,1607258,1607284,1607306,1607324,1607327,1607345,1607363,1607398,1607418,1607421,1607424,1607426,1607433,1607468,1607473,1607479,1607544,1607579,1607584,1607592,1607600,1607603,1607606,1607617,1607635,1607716,1607728,1607741,1607752,1607763,1607782,1607804,1607812,1607826,1607840,1607881,1607958,1607960,1607971,1607980,1607984,1608007,1608011,1608019,1608026,1608028,1608053,1608068,1608080,1608131,1608139,1608140,1608142,1608148,1608160,1608163,1608173,1608174,1608177,1608188,1608222,1608236,1608247,1608251,1608258,1608263,1608267,1608286,1608371,1608381,1608382,1608399,1608402,1608415,1608418,1608457,1608480,1608484,1608485,1608488,1608521,1608524,1608545,1608551,1608568,1608570,1608614,1608625,1608718,1608725,1608733,1608762,1608774,1608808,1608857,1608902,1608909,1608937,1609048,1609068,1609121,1609141,1609163,1609204,1609219,1609223,1609258,1609318,1609321,1609327,1609332,1609336,1609379,1609421,1609422,1609430,1609476,1609479,1609688,1609699,1609708,1609711,1609715,1609717,1609720,1609722,1609753,1609765,1609768,1609784,1609793,1609808,1609812,1609820,1609839,1609858,1609863,1609879,1609907,1609970,1609997,1610018,1610068,1610069,1610072,1610081,1610086,1610093,1610211,1610223,1610225,1610296,1610303,1610360,1610393,1610445,1610571,1610607,1610622,1610650,1610652,1610658,1610661,1610800,1610841,1610858,1610876,1610897,1610900,1610911,1610958,1611020,1611022,1611078,1611125,1611183,1611185,1611187,1611195,1611197,1611200,1611202,1611231,1611233,1611234,1611235,1611261,1611320,1611324,1611394,1611405,1611410,1611425,1611453,1611461,1611467,1611473,1611475,1611504,1611548,1611578,1611580,1611620,1611881,1611914,1612722,1612772,1613174,1613294,1613409,1613534,1613759,1614050,1614108,1614240,1614469,1614696,1615380,1615758,1616060,1616066,1616090,1616198,1616379,1616445,1616464,1616503,1616609,1616631,1616665,1616888,1616933,1616934,1616940,1617033,1617266,1617331,1617625,1617816,1618002,1618294,1618326,1618473,1618573,1618616,1618661,1618680,1618705,1619198,1619262,1619263,1619278,1619298,1619371,1619391,1619457,1619460,1619485,1619498,1619506,1619532,1619611,1619630,1619761,1620010,1620279,1620321,1620371,1620390,1620706,1620755,1620816,1620873,1620917,1620965,1620989,1621008,1621035,1621066,1884764,1884830,1885004,1885051,1888247,1941204,1954056,6691842,6698658,6698659,6845329,6845590,6865927,6908641,6908736,6941772,6957680,6957685,6957690,7026720,7026735,7026776,7026785,7026787,7026800,7026817,7026826,7026833,7026837,7026842,7026870,7026885,7026886,7026889,7026897,7026898,7026994,7026999,7027001,7027003,7072944,7092271,7096430,7100111,7280459,7302488,7302494,7323625,7325957,7325958,7383661,7383662,7421899,7510867,7510868,7510869,7510870,7510871,7510872,7510873,7510874,7510875,7510876,7510877,7510878,7510879,7510880,7510881,7510882,7510883,7510884,7510885,7510886,7510887,7510888,7510889,7510890,7510891,7510892,7510893,7510894,7510895,7510896,7510897,7510898,7510899,7510900,7510901,7510902,7510903,7510904,7510905,7510906,7510907,7510908,7510910,7510911,7510912,7510913,7510914,7510915,7510916,7510917,7510919,7510920,7510921,7510922,7510923,7510924,7510925,7510926,7510927,7510928,7510929,7510930,7510931,7510932,7510933,7510934,7510935,7510936,7510937,7510938,7510939,7510940,7510941,7510942,7510943,7510944,7510945,7510946,7510947,7510948,7510949,7510950,7510951,7510952,7510953,7510954,7510955,7510956,7510957,7510958,7510959,7510960,7510961,7510962,7510963,7510964,7510965,7510966,7510967,7510968,7510969,7510970,7510971,7510972,7510973,7510974,7510975,7510976,7510977,7510978,7510979,7510980,7510981,7510982,7510983,7510984,7510985,7510986,7510987,7510988,7510989,7510990,7510991,7510992,7510993,7510994,7510995,7510996,7510997,7510998,7510999,7511000,7511001,7511002,7511003,7511004,7511005,7511006,7511007,7511008,7511009,7511010,7511011,7511012,7511013,7511014,7511015,7511017,7511018,7511019,7511020,7511021,7511022,7511023,7511024,7511025,7511026,7511027,7511028,7511029,7511033,7511045,7511049,7511051,7511053,7511054,7524617,7525691,7603495,8181809,1614875];
